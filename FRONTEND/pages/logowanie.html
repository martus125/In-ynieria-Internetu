<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../styles/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" />
  <title>Logowanie | Hotel Olimp</title>
</head>
<body>
  <nav>
    <div class="nav__bar">
      <div class="nav__header">
        <div class="logo nav__logo">
          <div>H</div>
          <span>HOTEL<br />Olimp</span>
        </div>
        <button class="nav__menu__btn" id="menu-btn" aria-label="Otwórz menu">
          <i class="ri-menu-line"></i>
        </button>
      </div>
      <ul class="nav__links" id="nav--links">
        <li><a href="../src/index.html">Home</a></li>
        <li><a href="onas.html">O nas</a></li>
        <li><a href="pokoje.html">Pokoje</a></li>
        <li><a href="menu.html">Menu</a></li>
        <li><a href="eventy.html">Eventy</a></li>
        <li><a href="logowanie.html" class="active">Logowanie</a></li>
      </ul>
    </div>
  </nav>

  <!-- SZKLANY PANEL NA ŚRODKU -->
  <main class="auth-page">
    <section class="auth-card">
      <div class="auth-card__header">
        <i class="ri-user-3-line auth-card__icon"></i>
        <p class="auth-card__eyebrow">Panel użytkownika</p>
        <h1>Logowanie i rejestracja</h1>
        <p class="auth-card__subtitle">
          Utwórz konto, a potem zaloguj się, aby zarezerwować pokój.
        </p>
      </div>

      <div class="auth-card__body">
        <!-- KOLUMNA REJESTRACJI -->
        <div class="auth-column">
          <h3>Rejestracja</h3>
          <form id="regForm" class="auth-form">
            <label>
              Login
              <input name="login" required />
            </label>
            <label>
              Hasło
              <input name="password" type="password" minlength="6" required />
            </label>
            <button class="btn" type="submit">Zarejestruj</button>
            <p id="regMsg"></p>
          </form>
        </div>

        <!-- KOLUMNA LOGOWANIA -->
        <div class="auth-column">
          <h3>Logowanie</h3>
          <form id="loginForm" class="auth-form">
            <label>
              Login
              <input name="login" required />
            </label>
            <label>
              Hasło
              <input name="password" type="password" required />
            </label>
            <button class="btn" type="submit">Zaloguj</button>
            <p id="loginMsg"></p>
          </form>

          <div class="auth-extra-actions">
            <button class="btn btn--ghost" id="whoamiBtn" type="button">
              Kim jestem?
            </button>
            <button class="btn btn--ghost" id="logoutBtn" type="button">
              Wyloguj
            </button>
            <p id="whoamiMsg"></p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

    <script>
  const API = 'http://localhost:3001';

  // wspólna funkcja do wywoływania backendu
  async function request(url, opts){
    try{
      const r = await fetch(url, opts);
      let body = {};
      try { body = await r.json(); } catch(e){}
      return { ok: r.ok, status: r.status, body };
    }catch(err){
      return { ok: false, status: 0, body: { error: "Brak połączenia z backendem" } };
    }
  }

  // małe wyskakujące powiadomienie
  function showToast(message, timeout = 4500){
    const toast = document.getElementById('toast');
    if (!toast) return;

    toast.textContent = message;
    toast.classList.add('toast--visible');

    if (toast._hideTimeout){
      clearTimeout(toast._hideTimeout);
    }
    toast._hideTimeout = setTimeout(()=>{
      toast.classList.remove('toast--visible');
    }, timeout);
  }

  // kliknięcie w powiadomienie je chowa
  const toastEl = document.getElementById('toast');
  if (toastEl){
    toastEl.addEventListener('click', () => {
      toastEl.classList.remove('toast--visible');
    });
  }

  // REJESTRACJA
  document.getElementById('regForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const body = Object.fromEntries(new FormData(e.currentTarget).entries());
    const res  = await request(API + '/api/auth/register', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify(body)
    });

    const msg = res.ok ? 'Konto utworzone!' : (res.body.error || 'Błąd rejestracji');
    document.getElementById('regMsg').textContent = msg;
    if (!res.ok) showToast(msg);
  });

  // LOGOWANIE
    // LOGOWANIE
  // LOGOWANIE
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const body = Object.fromEntries(new FormData(e.currentTarget).entries());
  const res  = await request(API + '/api/auth/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify(body)
  });

  let msg;

  if (res.ok){
    msg = 'Zalogowano!';
  } else if (res.status === 401 || res.status === 404){
    msg = 'Najpierw trzeba się zarejestrować, a dopiero potem zalogować.';
  } else if (res.status === 0){
    msg = res.body.error || 'Brak połączenia z backendem';
  } else {
    msg = res.body.error || 'Błąd logowania';
  }

  document.getElementById('loginMsg').textContent = msg;
  if (!res.ok) showToast(msg);
});



  // WYLOGOWANIE
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await request(API + '/api/auth/logout',{ method:'POST', credentials:'include' });
    const msg = 'Wylogowano';
    document.getElementById('whoamiMsg').textContent = msg;
    showToast(msg, 2500);
  });

  // KIM JESTEM
  document.getElementById('whoamiBtn').addEventListener('click', async ()=>{
    const res = await request(API + '/api/auth/me',{ credentials:'include' });
    const msg = res.ok && res.body?.user
      ? ('Zalogowany jako: ' + res.body.user.login)
      : (res.body.error || 'Nie zalogowano');
    document.getElementById('whoamiMsg').textContent = msg;
    showToast(msg, 3000);
  });

  // hamburger
  (function(){
    const btn = document.getElementById('menu-btn');
    const links = document.getElementById('nav--links');
    if (btn && links) btn.addEventListener('click', ()=> links.classList.toggle('open'));
  })();
  </script>

</body>
</html>
